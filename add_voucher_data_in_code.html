<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Add Vouchers with Specific Field Types</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="auth/firebase-config.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 40px auto;
        text-align: center;
      }

      button {
        padding: 10px 20px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 20px;
      }

      #status {
        margin-top: 20px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <h2>Add Voucher (Reference + Timestamp + Image in MongoDB)</h2>
    <input type="file" id="voucher-image-upload" accept="image/*" />
    <button id="addVoucherBtn">Add Voucher</button>
    <div id="status"></div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const statusEl = document.getElementById("status");

        if (!firebase.apps.length) {
          console.error("Firebase not initialized. Check firebase-config.js");
          statusEl.textContent = "Firebase not initialized.";
          statusEl.style.color = "red";
          return;
        }

        const db = firebase.firestore();
        console.log("Firestore initialized");

        let tempImageBase64 = null;

        // Preview and store image temporarily
        const imageInput = document.getElementById("voucher-image-upload");
        imageInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            tempImageBase64 = event.target.result; // store temporarily
            console.log("Image loaded for upload:", tempImageBase64);
          };
          reader.readAsDataURL(file);
        });

        async function addVoucher() {
          statusEl.textContent = "Adding voucher...";
          statusEl.style.color = "black";
          console.log("Button clicked. Preparing voucher...");

          try {
            const voucherId = db.collection("vouchers").doc().id; // generate ID
            let imageId = null;

            if (tempImageBase64) {
              const res = await fetch("http://localhost:3000/upload", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  type: "voucher",
                  voucher_id: voucherId,
                  data: tempImageBase64,
                }),
              });
              const result = await res.json();
              if (result.success) {
                imageId = result.id;
                console.log("Image saved to MongoDB with ID:", imageId);
              }
            }

            const voucher = {
              category_id: db.doc("categories/travel"),
              created_date: firebase.firestore.Timestamp.fromDate(
                new Date("2025-08-06T14:57:08Z")
              ),
              title: "Free Luggage Allowance Upgrade",
              description:
                "Receive an additional 10kg luggage allowance on selected domestic flights.",
              image: imageId || "",
              is_latest: "true",
              points: "150",
              terms_and_condition:
                "Valid for participating airlines only. Subject to seat availability. Expires 31 Dec 2025.",
            };

            console.log("Voucher object:", voucher);

            await db.collection("vouchers").doc(voucherId).set(voucher); // use voucherId

            statusEl.textContent = "Voucher added successfully!";
            statusEl.style.color = "green";
            console.log("Voucher added!");
            imageInput.value = ""; // clear file input
            tempImageBase64 = null;
          } catch (error) {
            console.error("Error adding voucher:", error);
            statusEl.textContent = "Failed to add voucher.";
            statusEl.style.color = "red";
          }
        }

        document
          .getElementById("addVoucherBtn")
          .addEventListener("click", addVoucher);
      });
    </script>
  </body>
</html>
