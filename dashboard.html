<!DOCTYPE html>
<html>
  <head>
    <title>Dashboard | OptimaBankWeb</title>
    <link rel="stylesheet" href="css/dashboard.css" />
    <link rel="stylesheet" href="css/header.css" />
    <link rel="stylesheet" href="css/footer.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="auth/firebase-config.js"></script>
    <script src="user_points.js"></script>

    <script>
      function logout() {
        firebase
          .auth()
          .signOut()
          .then(() => {
            window.location.href = "auth/login.html";
          });
      }
    </script>
    <style>
      .category-filters {
        text-align: center;
        margin: 20px 0;
      }

      .category-btn {
        background: #eee;
        border: none;
        padding: 8px 14px;
        margin: 5px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
      }

      .category-btn.active {
        background: #6a0dad;
        color: white;
      }

      .redeem-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }
      .redeem-modal.hidden {
        display: none;
      }
      .redeem-modal-content {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        width: 300px;
      }
      .qty-controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 15px 0;
      }
    </style>
  </head>

  <body>
    <script>
      // Listen for authentication state changes
      firebase.auth().onAuthStateChanged(async function (user) {
        if (user) {
          const db = firebase.firestore();
          try {
            const doc = await db.collection("users").doc(user.uid).get();
            let displayName = "User";
            if (doc.exists) {
              displayName =
                doc.data().name || user.displayName || user.email.split("@")[0];
            } else {
              displayName = user.displayName || user.email.split("@")[0];
            }
            document.getElementById("user-shortname").textContent = displayName;
            document.getElementById("profile-pic").title = displayName;
          } catch (error) {
            console.error("Error fetching user data:", error);
          }
        } else {
          window.location.href = "auth/login.html";
        }
      });
    </script>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="navbar-left">
        <span class="logo">OptimaBank</span>
      </div>
      <div class="navbar-center">
        <a href="#">Home</a>
        <div class="dropdown" id="voucherDropdown">
          <a href="#" class="dropdown-toggle" id="dropdownBtn">
            Voucher <span class="dropdown-arrow">&#9662;</span>
          </a>
          <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item">
              <div class="dropdown-title">Baverage</div>
              <div class="dropdown-desc">
                All Kind of Baverage vaucher available here
              </div>
              <span class="dropdown-chevron">&#8250;</span>
            </div>
            <div class="dropdown-item">
              <div class="dropdown-title">Food</div>
              <div class="dropdown-desc">
                All Kind of Food vaucher available here
              </div>
              <span class="dropdown-chevron">&#8250;</span>
            </div>
            <div class="dropdown-item">
              <div class="dropdown-title">Travel</div>
              <div class="dropdown-desc">
                Discounts on flights, hotels, or vacation packages.
              </div>
              <span class="dropdown-chevron">&#8250;</span>
            </div>
          </div>
        </div>
      </div>
      <div class="navbar-right">
        <a href="carts/cart.html">
          <span class="cart-icon">&#128722;</span>
        </a>

        <!-- Cart History / Voucher History button with image -->
        <a href="carts/user_voucher.html" class="cart-history-btn">
          <img
            src="assets/voucher.png"
            class="voucher-icon"
            alt="Your Voucher"
          />
          <span class="voucher-text">Your Voucher</span>
        </a>

        <a href="carts/history.html" class="cart-history-btn">
          <img src="assets/clock.png" class="voucher-icon" alt="V History" />
          <span class="voucher-text">V History</span>
        </a>

        <script>
          firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) return;

            const userDoc = await firebase
              .firestore()
              .collection("users")
              .doc(user.uid)
              .get();
            const userData = userDoc.data();

            if (userData?.profile_image) {
              try {
                const res = await fetch(
                  `http://localhost:3000/image/${userData.profile_image}`
                );
                const imgData = await res.json();
                if (imgData.success) {
                  document.getElementById("profile-pic").src = imgData.base64;
                }
              } catch (err) {
                console.error("Error fetching profile image:", err);
              }
            }

            // Optional: show user's points in navbar
            const pointsEl = document.getElementById("points-header");
            if (pointsEl && userData?.points != null) {
              pointsEl.textContent = `${userData.points} Points`;
            }
          });
        </script>

        <a href="auth/profile.html">
          <img
            id="profile-pic"
            class="profile-pic"
            src="assets/default-profile.png"
            alt="Profile"
          />
        </a>

        <span id="user-shortname">loading...</span>
        <span id="points-header" class="points"> counting... Points</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </nav>

    <!-- Reward Point Balance Section -->
    <div class="dashboard-header">
      <div class="reward-info">
        <div class="reward-label">Reward Point Balance</div>
        <div class="reward-points" id="points-balance">
          counting.. <span class="coin-icon">🪙</span>
        </div>
      </div>
      <!-- Example: Big profile image (optional, can be styled/added later) -->
      <!-- <img class="header-profile-pic" src="img/default-profile.png" alt="Profile" /> -->
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        const db = firebase.firestore();
        const auth = firebase.auth();
        const voucherListEl = document.getElementById("voucher-list");
        const categoryFiltersEl = document.querySelector(".category-filters");

        async function getVoucherImage(mongoId) {
          try {
            const res = await fetch(`http://localhost:3000/image/${mongoId}`);
            const data = await res.json();
            if (data.success) return data.base64;
            return "../assets/giftcard.jpg"; // fallback
          } catch (err) {
            console.error("Error fetching voucher image:", err);
            return "../assets/giftcard.jpg";
          }
        }

        async function addToCart(userId, voucherId) {
          try {
            const userRef = db.collection("users").doc(userId);
            const voucherRef = db.collection("vouchers").doc(voucherId);

            const querySnapshot = await db
              .collection("cart_items")
              .where("user_id", "==", userRef)
              .where("voucher_id", "==", voucherRef)
              .get();

            if (!querySnapshot.empty) {
              const doc = querySnapshot.docs[0];
              const currentQty = parseInt(doc.data().quantity) || 1;
              await db
                .collection("cart_items")
                .doc(doc.id)
                .update({
                  quantity: currentQty + 1,
                });
            } else {
              await db.collection("cart_items").add({
                user_id: userRef,
                voucher_id: voucherRef,
                quantity: 1,
              });
            }

            alert("Voucher added to cart!");
          } catch (error) {
            console.error("Error adding to cart:", error);
            alert("Failed to add to cart. Please try again.");
          }
        }
        function createRedeemModal() {
          const modal = document.createElement("div");
          modal.id = "redeem-modal";
          modal.className = "redeem-modal hidden";
          modal.innerHTML = `
    <div class="redeem-modal-content">
      <h3 id="redeem-title"></h3>
      <p id="redeem-description"></p>
      <p><strong><span id="redeem-points"></span> points</strong></p>

      <div class="qty-controls">
        <button id="qty-decrease">-</button>
        <span id="qty-value">1</span>
        <button id="qty-increase">+</button>
      </div>

      <button id="confirm-redeem">Redeem</button>
      <button id="close-redeem">Cancel</button>
    </div>
  `;
          document.body.appendChild(modal);
          return modal;
        }

        async function openRedeemModal(userId, voucher, cartId = null) {
          let modal = document.getElementById("redeem-modal");
          if (!modal) modal = createRedeemModal();

          modal.classList.remove("hidden");

          const titleEl = document.getElementById("redeem-title");
          const descEl = document.getElementById("redeem-description");
          const pointsEl = document.getElementById("redeem-points");
          const qtyValueEl = document.getElementById("qty-value");
          const qtyDecreaseBtn = document.getElementById("qty-decrease");
          const qtyIncreaseBtn = document.getElementById("qty-increase");
          const confirmBtn = document.getElementById("confirm-redeem");
          const closeBtn = document.getElementById("close-redeem");

          let qty = 1;

          // Fill in voucher details
          titleEl.textContent = voucher.title || "Voucher";
          descEl.textContent = voucher.description || "";
          pointsEl.textContent = voucher.points || 0;
          qtyValueEl.textContent = qty;

          qtyDecreaseBtn.onclick = () => {
            if (qty > 1) {
              qty--;
              qtyValueEl.textContent = qty;
            }
          };

          qtyIncreaseBtn.onclick = () => {
            qty++;
            qtyValueEl.textContent = qty;
          };

          closeBtn.onclick = () => {
            modal.classList.add("hidden");
          };

          confirmBtn.onclick = async () => {
            try {
              if (!voucher.id) throw new Error("Voucher id is missing!");

              const userRef = db.collection("users").doc(userId);
              const voucherRef = db.collection("vouchers").doc(voucher.id);

              const totalPoints = voucher.points * qty;

              // 1️⃣ Create voucher_history first
              const historyRef = await db.collection("voucher_history").add({
                user_id: userRef, // reference
                voucher_id: voucherRef, // reference
                quantity: qty,
                total_points: totalPoints,
                completed_date: firebase.firestore.Timestamp.now(),
              });

              // 2️⃣ Add each voucher to users_voucher_list in a batch
              const batch = db.batch();
              for (let i = 0; i < qty; i++) {
                const docRef = db.collection("users_voucher_list").doc();
                batch.set(docRef, {
                  user_id: userRef, // reference
                  voucher_id: voucherRef, // reference
                  history_id: historyRef, // reference to voucher_history
                  added_date: firebase.firestore.Timestamp.now(),
                  redeem: false,
                  redeem_date: null,
                });
              }

              // 3️⃣ Decrease user points in the same batch
              batch.update(userRef, {
                points: firebase.firestore.FieldValue.increment(-totalPoints),
              });

              // ✅ Commit batch (users_voucher_list + points deduction)
              await batch.commit();

              alert(`Voucher redeemed successfully! ${qty} x ${voucher.title}`);
              modal.classList.add("hidden");

              // 4️⃣ Remove from cart if applicable
              if (cartId) {
                const cartItemEl = document.getElementById(
                  `cartItem-${cartId}`
                );
                if (cartItemEl) cartItemEl.remove();
                await db.collection("cart_items").doc(cartId).delete();
              }
            } catch (err) {
              console.error("Redeem failed:", err);
              alert("Failed to redeem voucher: " + err.message);
            }
          };
        }

        async function loadVouchers(userId, selectedCategoryId = "All") {
          const snapshot = await db.collection("vouchers").get();
          const vouchers = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          voucherListEl.innerHTML = "";

          // Filter vouchers
          const filteredVouchers =
            selectedCategoryId === "All"
              ? vouchers
              : vouchers.filter((v) => {
                  // if category_id is a Firestore document reference
                  if (v.category_id && v.category_id.id) {
                    return v.category_id.id === selectedCategoryId;
                  }
                  // if category_id is stored as string
                  return v.category_id === selectedCategoryId;
                });

          if (!filteredVouchers.length) {
            voucherListEl.innerHTML = `<p>No vouchers available.</p>`;
            return;
          }

          for (const voucher of filteredVouchers) {
            let imageSrc = "../assets/giftcard.jpg";
            if (voucher.image) {
              imageSrc = await getVoucherImage(voucher.image);
            }

            const card = document.createElement("div");
            card.className = "promo-card";
            card.innerHTML = `
  <img src="${imageSrc}" alt="Promo" class="promo-img" />
  <div class="promo-desc">
    <strong>${voucher.title || "Voucher"}</strong><br />
    <span class="promo-points">${voucher.points || 0} points</span>
    <div class="promo-body">${voucher.description || ""}</div>
    <button class="add-to-cart-btn">Add to Cart</button>
    <button class="redeem-btn">Redeem</button>
  </div>
`;

            card
              .querySelector(".add-to-cart-btn")
              .addEventListener("click", () => addToCart(userId, voucher.id));

            card
              .querySelector(".redeem-btn")
              .addEventListener("click", () =>
                openRedeemModal(userId, voucher)
              );

            voucherListEl.appendChild(card);
          }
        }

        async function loadCategories(userId) {
          try {
            const snapshot = await db.collection("categories").get();
            const categories = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            // Build category filter buttons
            categoryFiltersEl.innerHTML = "";

            const allBtn = document.createElement("button");
            allBtn.textContent = "All Latest";
            allBtn.className = "category-btn active";
            allBtn.dataset.category = "All";
            categoryFiltersEl.appendChild(allBtn);

            for (const cat of categories) {
              const btn = document.createElement("button");
              btn.textContent = cat.name;
              btn.className = "category-btn";
              btn.dataset.category = cat.id;
              categoryFiltersEl.appendChild(btn);
            }

            // Event listeners for category switching
            categoryFiltersEl
              .querySelectorAll(".category-btn")
              .forEach((btn) => {
                btn.addEventListener("click", async () => {
                  categoryFiltersEl
                    .querySelectorAll(".category-btn")
                    .forEach((b) => b.classList.remove("active"));
                  btn.classList.add("active");

                  // Reload vouchers when category changes
                  await loadVouchers(userId, btn.dataset.category);
                });
              });

            // Load all vouchers by default
            await loadVouchers(userId, "All");
          } catch (error) {
            console.error("Error loading categories:", error);
          }
        }

        try {
          const user = auth.currentUser;
          if (!user) {
            auth.onAuthStateChanged(async (user) => {
              if (user) {
                await loadCategories(user.uid);
              } else {
                voucherListEl.innerHTML =
                  "<p>Please log in to view and add vouchers to cart.</p>";
              }
            });
          } else {
            await loadCategories(user.uid);
          }
        } catch (error) {
          console.error("Error initializing dashboard:", error);
          voucherListEl.innerHTML = "<p>Error loading dashboard.</p>";
        }
      });
    </script>

    <div class="category-filters">
      <p>Loading categories...</p>
    </div>

    <!-- Promotions Section -->
    <div class="promotions-section">
      <h2 class="promotions-title">Promotions & New deals</h2>
      <div class="promotions-grid" id="voucher-list">
        <p>Loading vouchers...</p>
      </div>
    </div>

    <!-- Footer Section -->
    <footer class="footer">
      <div class="footer-container">
        <div class="footer-col">
          <h4>Loyalty Rewards</h4>
          <p>
            Earn points on every purchase and redeem for exclusive rewards and
            experiences.
          </p>
        </div>
        <div class="footer-col">
          <h4>Quick Links</h4>
          <ul>
            <li><a href="#">Rewards Catalog</a></li>
            <li><a href="#">Terms & Conditions</a></li>
            <li><a href="#">FAQ</a></li>
            <li><a href="#">Contact Support</a></li>
          </ul>
        </div>
        <div class="footer-col">
          <h4>Connect With Us</h4>
          <div class="footer-socials">
            <span class="footer-social"></span>
            <span class="footer-social"></span>
            <span class="footer-social"></span>
          </div>
          <div class="footer-newsletter">
            <span>Subscribe to our newsletter</span>
            <div class="newsletter-input">
              <input type="email" placeholder="Your email" />
              <button type="button"></button>
            </div>
          </div>
        </div>
        <div class="footer-col">
          <h4>Download App</h4>
          <a href="#" class="footer-app-btn appstore"
            >Download on the<br /><strong>App Store</strong></a
          >
          <a href="#" class="footer-app-btn googleplay"
            >Get it on<br /><strong>Google Play</strong></a
          >
        </div>
      </div>
      <div class="footer-bottom">
        © 2023 Loyalty Rewards. All rights reserved.
      </div>
    </footer>
  </body>
</html>
